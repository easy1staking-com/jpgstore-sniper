package com.easy1staking.jpgstore.jpgstorejavaclient.datum;

import com.bloxbean.cardano.client.metadata.cbor.CBORMetadata;
import com.bloxbean.cardano.client.util.HexUtil;
import com.easy1staking.jpgstore.sniper.service.ListingDatumParser;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;

import java.util.stream.Collectors;

@Slf4j

public class ListDatumParserTest {

    private static final ObjectMapper OBJECT_MAPPER = new ObjectMapper();

    private static final ListingDatumParser LISTING_DATUM_PARSER = new ListingDatumParser(OBJECT_MAPPER);

    @Test
    public void deserializeListingMetadataV2_1() {

        var listingMetadataCbor = "a8181e61371832784064383739396639666438373939666438373939666438373939663538316366353537653066383937303934636431396162323231393436646562306266383136183378403166326439663139366239333038353638626230343866666438373939666438373939666438373939663538316332626638373561346335653561643663343818347840383963613039663365373439313263363735353930353965386261393063316461346336663266666666666666663161303039363235383066666438373939661835784064383739396664383739396635383163323734343632383034626436663461653535303464653537633930363933636236333835373038336430383564323133183678403933343033663236666664383739396664383739396664383739396635383163613037376564376330363662636566313337303934646661373732653563643718377840623838353365656134333138373230353733643962626263666666666666666631613036386663333838666666663538316332373434363238303462643666341838782d61653535303464653537633930363933636236333835373038336430383564323133393334303366323666662c";
        var datumHash = "cb9eced407174a58f49ea5056bf66c5cedcb5325b8e90bbd7ef282b39277f8b6";

        var metadataMap = CBORMetadata.deserialize(HexUtil.decodeHexString(listingMetadataCbor));

        String listingMetadata = metadataMap
                .getData()
                .getValues()
                .stream()
                .map(Object::toString)
                .toList()
                .stream()
                .skip(1)
                .collect(Collectors.joining());

        log.info("listingMetadata: {}", listingMetadata);

        var listingDetailsOpt = LISTING_DATUM_PARSER.parsePaymentDetailsV2(listingMetadataCbor,  datumHash);
        if (listingDetailsOpt.isEmpty()) {
            Assertions.fail();
        }

        var listingDetails = listingDetailsOpt.get();
        log.info("listingDetails: {}", listingDetails);


    }

    @Test
    public void deserializeListingMetadataV2_2() {

        var listingMetadataCbor = "b81d181e61371832784064383739396639666438373939666438373939666438373939663538316337393031356632666335363336383832616434653062623563356237653739363536183378403531353865336565643362643366396336623439366666666438373939666438373939666438373939663538316332393938333836663530393830666665363518347840343861363061326533656532613165636631373533373563636336356630613032633833666566666666666666663161303038393534343066666438373939661835784064383739396664383739396635383163383731636638366466363136373566343437366137626566666434623364313762303664626430383136323764386136183678403132336532383237666664383739396664383739396664383739396635383163616637663136336261326231343461303564313234313565633033313732353318377840313864653964633163653934363731643533333463316539666666666666666631613035343636373230666666663538316338373163663836646636313637351838782d66343437366137626566666434623364313762303664626430383136323764386136313233653238323766662c1839784064383739396639666438373939666438373939666438373939663538316337393031356632666335363336383832616434653062623563356237653739363536183a784035313538653365656433626433663963366234393666666664383739396664383739396664383739396635383163323939383338366635303938306666653635183b784034386136306132653365653261316563663137353337356363633635663061303263383366656666666666666666316130303839353434306666643837393966183c784064383739396664383739396635383163383731636638366466363136373566343437366137626566666434623364313762303664626430383136323764386136183d784031323365323832376666643837393966643837393966643837393966353831636166376631363362613262313434613035643132343135656330333137323533183e784031386465396463316365393436373164353333346331653966666666666666663161303534363637323066666666353831633837316366383664663631363735183f782d66343437366137626566666434623364313762303664626430383136323764386136313233653238323766662c1840784064383739396639666438373939666438373939666438373939663538316337393031356632666335363336383832616434653062623563356237653739363536184178403531353865336565643362643366396336623439366666666438373939666438373939666438373939663538316332393938333836663530393830666665363518427840343861363061326533656532613165636631373533373563636336356630613032633833666566666666666666663161303036366666333066666438373939661843784064383739396664383739396635383163383731636638366466363136373566343437366137626566666434623364313762303664626430383136323764386136184478403132336532383237666664383739396664383739396664383739396635383163616637663136336261326231343461303564313234313565633033313732353318457840313864653964633163653934363731643533333463316539666666666666666631613033663265353130666666663538316338373163663836646636313637351846782d66343437366137626566666434623364313762303664626430383136323764386136313233653238323766662c184778406438373939663966643837393966643837393966643837393966353831633739303135663266633536333638383261643465306262356335623765373936353618487840353135386533656564336264336639633662343936666666643837393966643837393966643837393966353831633239393833383666353039383066666536351849784034386136306132653365653261316563663137353337356363633635663061303263383366656666666666666666316130303839353434306666643837393966184a784064383739396664383739396635383163383731636638366466363136373566343437366137626566666434623364313762303664626430383136323764386136184b784031323365323832376666643837393966643837393966643837393966353831636166376631363362613262313434613035643132343135656330333137323533184c784031386465396463316365393436373164353333346331653966666666666666663161303534363637323066666666353831633837316366383664663631363735184d782d66343437366137626566666434623364313762303664626430383136323764386136313233653238323766662c";
        var datumHash1 = "b74721b70eca15258750e3e0ff8680538a62390e65542f0f25f3394dd6785c04";
        var datumHash2 = "b74721b70eca15258750e3e0ff8680538a62390e65542f0f25f3394dd6785c04";
        var datumHash3 = "f390bf6d176080f967d75425b82b8010c2c5e29d66b6f67ba98bb517e13a7bba";
        var datumHash4 = "b74721b70eca15258750e3e0ff8680538a62390e65542f0f25f3394dd6785c04";

        var listingDetailsOpt = LISTING_DATUM_PARSER.parsePaymentDetailsV2(listingMetadataCbor,  datumHash3);
        if (listingDetailsOpt.isEmpty()) {
            Assertions.fail();
        }

        var listingDetails = listingDetailsOpt.get();
        log.info("listingDetails: {}", listingDetails);


    }

}
